<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PERPLEX ‚Äî Perp DEX Analytics</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap');

*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#060810;--bg2:#0a0d17;--bg3:#0f1220;--bg4:#151929;--bg5:#1b2035;
  --border:#161a2a;--border2:#1e2338;--border3:#262c42;
  --text:#e6e8f0;--text2:#9ea3be;--text3:#5a6080;
  --blue:#4c7cf7;--cyan:#1de9c2;--green:#00d68f;--red:#ff5c6b;
  --orange:#ffaa2c;--purple:#9d6cf7;--pink:#f76cb4;
  --grad1:linear-gradient(135deg,#4c7cf7,#1de9c2);
  --grad2:linear-gradient(135deg,#9d6cf7,#f76cb4);
}
html{scroll-behavior:smooth}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;overflow-x:hidden}

/* Ambient bg */
.ambient{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:0}
.ambient .orb{position:absolute;border-radius:50%;filter:blur(120px);opacity:.06}
.ambient .orb1{width:600px;height:600px;background:var(--blue);top:-200px;left:-100px}
.ambient .orb2{width:500px;height:500px;background:var(--purple);top:40%;right:-150px}
.ambient .orb3{width:400px;height:400px;background:var(--cyan);bottom:-100px;left:30%}

.wrap{max-width:1280px;margin:0 auto;padding:0 20px;position:relative;z-index:1}

/* TOP BANNER */
.top-banner{background:linear-gradient(90deg,rgba(76,124,247,.08),rgba(29,233,194,.06),rgba(157,108,247,.08));border-bottom:1px solid rgba(76,124,247,.1);padding:8px 0;text-align:center;position:relative;z-index:1}
.top-banner span{font-size:11px;color:var(--text2);font-weight:500}
.top-banner a{color:var(--cyan);text-decoration:none;font-weight:700;margin-left:4px;transition:all .2s}
.top-banner a:hover{text-decoration:underline;filter:brightness(1.2)}

/* NAV */
nav{position:sticky;top:0;z-index:100;background:rgba(6,8,16,.88);backdrop-filter:blur(28px) saturate(1.6);-webkit-backdrop-filter:blur(28px) saturate(1.6);border-bottom:1px solid var(--border)}
.nav-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 0;gap:12px}
.logo{display:flex;align-items:center;gap:9px;text-decoration:none}
.logo-mark{width:30px;height:30px;border-radius:8px;background:var(--grad1);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;color:#fff;box-shadow:0 0 20px rgba(76,124,247,.25),inset 0 1px 0 rgba(255,255,255,.15)}
.logo-text{font-size:16px;font-weight:800;letter-spacing:-.3px;color:var(--text)}.logo-sub{color:var(--text3);font-weight:400;font-size:11px;margin-left:5px;border-left:1px solid var(--border2);padding-left:8px}
.nav-r{display:flex;align-items:center;gap:8px}
.nav-chip{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:7px;background:var(--bg3);font-size:10px;color:var(--text2);font-weight:600;border:1px solid var(--border);font-family:'JetBrains Mono',monospace}
.nav-chip .dot{width:5px;height:5px;border-radius:50%;background:var(--green);box-shadow:0 0 8px rgba(0,214,143,.5);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}
.rbtn{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:8px;background:rgba(76,124,247,.12);border:1px solid rgba(76,124,247,.2);color:var(--blue);font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s}
.rbtn:hover{background:rgba(76,124,247,.2);box-shadow:0 0 16px rgba(76,124,247,.15)}
.rbtn:disabled{opacity:.4;cursor:not-allowed}
.rbtn.spin svg{animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* HERO */
.hero{padding:44px 0 8px;position:relative}
.hero-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px 4px 6px;border-radius:20px;background:rgba(76,124,247,.06);border:1px solid rgba(76,124,247,.12);font-size:10px;font-weight:700;color:var(--blue);margin-bottom:14px;text-transform:uppercase;letter-spacing:.8px}
.hero-badge .hb-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:blink 2s infinite}
.hero h1{font-size:clamp(26px,4.5vw,46px);font-weight:900;letter-spacing:-1.8px;line-height:1.06;margin-bottom:8px}
.hero .g1{background:var(--grad1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero .g2{background:var(--grad2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero p{color:var(--text3);font-size:14px;max-width:520px;line-height:1.65;margin-bottom:4px}
.hero-stats{display:flex;gap:16px;margin-top:14px;flex-wrap:wrap}
.hs{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3);padding:4px 10px;border-radius:6px;background:var(--bg3);border:1px solid var(--border);font-weight:500}
.hs strong{color:var(--text2);font-weight:700}
.hs.ok{border-color:rgba(0,214,143,.15);color:var(--green)}
.hs.err{border-color:rgba(255,92,107,.15);color:var(--red)}

/* MARKET SNAPSHOT */
.snap{margin:28px 0;padding:24px;background:var(--bg2);border:1px solid var(--border);border-radius:16px;position:relative;overflow:hidden}
.snap::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(76,124,247,.3),rgba(29,233,194,.2),transparent)}
.snap-title{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:18px;display:flex;align-items:center;gap:6px}
.snap-title::after{content:'';flex:1;height:1px;background:var(--border)}
.snap-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0;position:relative}
.snap-grid::after{display:none}
.sg-card{padding:0 20px;position:relative}
.sg-card:not(:last-child)::after{content:'';position:absolute;right:0;top:8px;bottom:8px;width:1px;background:var(--border)}
.sg-card .sg-label{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px;display:flex;align-items:center;gap:5px}
.sg-card .sg-val{font-size:clamp(18px,2.2vw,28px);font-weight:800;letter-spacing:-.5px;font-family:'JetBrains Mono','Inter',monospace;margin-bottom:3px}
.sg-card .sg-sub{font-size:10px;color:var(--text3);font-weight:500}
.sg-val.cyan{color:var(--cyan)}.sg-val.purple{color:var(--purple)}.sg-val.white{color:var(--text);font-family:'Inter',sans-serif;font-size:clamp(15px,1.8vw,20px)}
.sg-accent{position:absolute;bottom:0;left:20px;right:20px;height:2px;border-radius:1px;opacity:.5}

/* DOMINANCE */
.dom-wrap{margin-bottom:20px}
.dom-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px 20px;margin-bottom:12px;position:relative;overflow:hidden}
.dom-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(76,124,247,.2),transparent)}
.dom-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.dom-hd h2{font-size:12px;font-weight:700;color:var(--text2);display:flex;align-items:center;gap:6px}
.dom-hd .dim{color:var(--text3);font-weight:400;font-size:10px}
.dom-hd .top-label{font-size:10px;color:var(--text3);font-weight:500}
.dom-hd .top-label strong{color:var(--cyan)}
.dom-bar{display:flex;height:8px;border-radius:4px;overflow:hidden;background:var(--bg4);gap:1px}
.dom-seg{height:100%;min-width:3px;transition:width .7s cubic-bezier(.22,1,.36,1);border-radius:1px;cursor:pointer;position:relative}
.dom-seg:hover{filter:brightness(1.3);transform:scaleY(1.3)}
.dom-seg:first-child{border-radius:4px 1px 1px 4px}
.dom-seg:last-child{border-radius:1px 4px 4px 1px}
.dom-leg{display:flex;flex-wrap:wrap;gap:4px 14px;margin-top:10px}
.dl-i{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text3);font-weight:500}
.dl-i strong{color:var(--text2);font-weight:700}
.dl-dot{width:7px;height:7px;border-radius:2px;flex-shrink:0}

/* TABLE */
.t-section{margin-bottom:28px}
.t-bar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.tabs{display:flex;gap:1px;background:var(--bg3);border-radius:9px;padding:3px;border:1px solid var(--border)}
.tb{padding:6px 13px;border-radius:7px;border:none;background:transparent;color:var(--text3);font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s}
.tb:hover{color:var(--text2)}
.tb.on{background:var(--bg5);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,.3)}
.sw{position:relative}
.sw svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text3)}
.si{background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:7px 11px 7px 30px;color:var(--text);font-family:inherit;font-size:12px;outline:none;width:180px;transition:all .2s}
.si:focus{border-color:rgba(76,124,247,.4);background:var(--bg4);box-shadow:0 0 0 3px rgba(76,124,247,.08)}
.si::placeholder{color:var(--text3)}

.tw{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:var(--bg2);position:relative}
.tw::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(76,124,247,.25),rgba(29,233,194,.15),transparent);z-index:2}
.ts{overflow-x:auto}
.ts::-webkit-scrollbar{height:3px}
.ts::-webkit-scrollbar-track{background:var(--bg2)}
.ts::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

table{width:100%;border-collapse:collapse;min-width:820px}
thead th{padding:10px 14px;text-align:left;font-size:9.5px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;background:var(--bg3);border-bottom:1px solid var(--border);white-space:nowrap;user-select:none}
.ths{cursor:pointer;transition:color .15s;display:inline-flex;align-items:center;gap:4px}
.ths:hover{color:var(--text2)}
.ths.act{color:var(--blue)}
.sa{display:inline-flex;flex-direction:column;gap:0;line-height:0}
.sa .a{font-size:7px;line-height:7px;color:var(--text3);opacity:.4;transition:all .15s}
.sa .a.on{color:var(--blue);opacity:1}

tbody tr{border-bottom:1px solid var(--border);transition:all .15s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:rgba(76,124,247,.02)}
td{padding:10px 14px;font-size:12px;white-space:nowrap}

.dc{display:flex;align-items:center;gap:10px}
.dav{width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;transition:transform .2s;position:relative}
tr:hover .dav{transform:scale(1.06)}
.dnf h4{font-size:12px;font-weight:700;color:var(--text);margin-bottom:1px;letter-spacing:-.2px}
.dnf span{font-size:9px;color:var(--text3);font-weight:500}

.rk{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;color:var(--text3);width:24px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:5px}
.rk.g{background:linear-gradient(135deg,rgba(255,170,44,.15),rgba(255,170,44,.05));color:var(--orange);box-shadow:0 0 8px rgba(255,170,44,.1)}
.rk.s{background:rgba(158,163,190,.08);color:var(--text2)}
.rk.b{background:rgba(184,115,51,.08);color:#c08040}

.v{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:12px}
.v.vc{color:var(--cyan)}.v.tc{color:var(--purple)}.v.na{color:var(--text3);font-weight:400;font-size:11px}

.ch{display:inline-flex;align-items:center;gap:2px;padding:2px 7px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600}
.ch.up{color:var(--green);background:rgba(0,214,143,.06)}
.ch.dn{color:var(--red);background:rgba(255,92,107,.06)}
.ch.na{color:var(--text3);background:var(--bg3)}

.sb{width:68px;height:4px;background:var(--bg4);border-radius:2px;overflow:hidden}
.sf{height:100%;border-radius:2px;transition:width .6s cubic-bezier(.22,1,.36,1)}

/* FOOTER */
footer{padding:24px 0 28px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px}
.fl{display:flex;align-items:center;gap:16px}
.fl .f-logo{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:700;color:var(--text2)}
.fl .f-logo .fm{width:20px;height:20px;border-radius:5px;background:var(--grad1);display:flex;align-items:center;justify-content:center;font-size:9px;color:#fff;font-weight:900}
.fl .sep{width:1px;height:14px;background:var(--border2)}
.fl .fsrc{font-size:10px;color:var(--text3)}
.fl a{color:var(--blue);text-decoration:none;font-weight:600}
.fr-build{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:8px;background:var(--bg3);border:1px solid var(--border);font-size:11px;color:var(--text3);transition:all .25s;text-decoration:none}
.fr-build:hover{border-color:var(--border3);background:var(--bg4);color:var(--text2);box-shadow:0 4px 16px rgba(0,0,0,.2)}
.fr-build .build-icon{font-size:13px}
.fr-build strong{color:var(--text2);font-weight:700}

/* TOOLTIP */
.tip{position:fixed;padding:5px 9px;border-radius:6px;background:var(--bg4);border:1px solid var(--border2);font-size:10px;color:var(--text);pointer-events:none;z-index:200;white-space:nowrap;box-shadow:0 6px 20px rgba(0,0,0,.5);display:none;font-weight:600;font-family:'JetBrains Mono',monospace}

/* RESPONSIVE */
@media(max-width:1024px){.snap-grid{grid-template-columns:repeat(2,1fr);gap:16px}.sg-card:not(:last-child)::after{display:none}.sg-card{padding:0}}
@media(max-width:640px){
  .wrap{padding:0 12px}
  .hero{padding:28px 0 8px}
  .snap-grid{grid-template-columns:1fr 1fr;gap:14px}
  .sg-card{padding:0}
  .nav-chip{display:none}
  .si{width:100%}
  .t-bar{flex-direction:column;align-items:stretch}
  .sw{width:100%}
  footer{flex-direction:column;align-items:flex-start}
  .dom-card{padding:14px}
  .hero-stats{gap:8px}
}
@media(max-width:400px){.snap-grid{grid-template-columns:1fr}.snap{padding:16px}}

/* Subtle row stripe */
tbody tr:nth-child(even){background:rgba(255,255,255,.008)}
tbody tr:nth-child(even):hover{background:rgba(76,124,247,.025)}
</style>
</head>
<body>

<div class="ambient"><div class="orb orb1"></div><div class="orb orb2"></div><div class="orb orb3"></div></div>
<div class="tip" id="tip"></div>

<div class="top-banner">
  <span>‚ö° Built by<a href="https://x.com/0xdierich" target="_blank">@0xdierich</a> ‚Äî Tracking the pulse of on-chain perp markets</span>
</div>

<nav><div class="wrap"><div class="nav-inner">
  <a href="#" class="logo"><div class="logo-mark">P</div><div class="logo-text">PERPLEX<span class="logo-sub">Perp DEX Overview</span></div></a>
  <div class="nav-r">
    <div class="nav-chip"><div class="dot"></div><span id="cd">--:--:--</span></div>
    <button class="rbtn" id="rb" onclick="go()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>Refresh</button>
  </div>
</div></div></nav>

<section class="hero"><div class="wrap">
  <div class="hero-badge"><div class="hb-dot"></div>Perpetual DEX Overview ¬∑ DefiLlama</div>
  <h1>Real-time <span class="g1">Perp Liquidity</span><br>across crypto markets</h1>
  <p>Daily perp volume and TVL metrics for curated on-chain derivatives venues. Updated every 24h directly from the DefiLlama API.</p>
  <div class="hero-stats">
    <div class="hs">Tracked Perp DEXs: <strong id="dc">35</strong></div>
    <div class="hs">Last update: <strong id="lu">‚Äî</strong></div>
    <div class="hs" id="stag"><span id="stxt">Syncing‚Ä¶</span></div>
  </div>
</div></section>

<section class="wrap"><div class="snap">
  <div class="snap-title">Perp Market Snapshot <span style="flex:0"></span></div>
  <div class="snap-grid" id="sg"></div>
</div></section>

<section class="wrap dom-wrap">
  <div class="dom-card">
    <div class="dom-hd"><h2>Volume Dominance <span class="dim">24h perp volume share</span></h2><div class="top-label" id="topVolLabel"></div></div>
    <div class="dom-bar" id="dvb"></div>
    <div class="dom-leg" id="dvl"></div>
  </div>
  <div class="dom-card">
    <div class="dom-hd"><h2>TVL Dominance <span class="dim">total liquidity share</span></h2><div class="top-label" id="topTvlLabel"></div></div>
    <div class="dom-bar" id="dtb"></div>
    <div class="dom-leg" id="dtl"></div>
  </div>
</section>

<section class="wrap t-section">
  <div class="t-bar">
    <div class="tabs" id="tg"></div>
    <div class="sw">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input class="si" type="text" placeholder="Search protocol or chain‚Ä¶" oninput="cF=this.value;renderT()"/>
    </div>
  </div>
  <div class="tw"><div class="ts">
    <table><thead><tr id="th"></tr></thead><tbody id="tb"><tr><td colspan="7" style="text-align:center;padding:52px;color:var(--text3)"><div style="display:flex;flex-direction:column;align-items:center;gap:10px"><div style="width:22px;height:22px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite"></div><span style="font-size:11px">Fetching from DefiLlama‚Ä¶</span></div></td></tr></tbody></table>
  </div></div>
</section>

<section class="wrap"><footer>
  <div class="fl">
    <div class="f-logo"><div class="fm">P</div>PERPLEX</div>
    <div class="sep"></div>
    <div class="fsrc">Data from <a href="https://defillama.com" target="_blank">DefiLlama</a> API</div>
  </div>
  <a href="https://x.com/0xdierich" target="_blank" class="fr-build">
    <span class="build-icon">‚ö°</span> Built by <strong>@0xdierich</strong>
  </a>
</footer></section>

<script>
const CC=['#4c7cf7','#9d6cf7','#1de9c2','#00d68f','#ffaa2c','#ff5c6b','#f76cb4','#14b8a6','#f97316','#6366f1','#84cc16','#e879f9','#22d3ee','#fb923c','#a78bfa','#34d399','#fbbf24','#f472b6','#38bdf8','#c084fc','#4ade80','#fb7185','#2dd4bf','#a3e635','#facc15','#818cf8','#7dd3fc','#d946ef','#f0abfc','#bef264','#fda4af','#5eead4','#fcd34d','#c4b5fd','#67e8f9'];
const EE=['üü¢','üîµ','‚ö°','üíé','üåÄ','üî∑','üéØ','üê¨','üî∂','üü£','üåô','üî¥','‚¨°','üêá','üü†','üíú','üåü','‚≠ê','üî•','üí´','‚ú®','ü™ê','üåà','üé™','üèÜ','üé≤','üéÆ','üöÄ','üí∞','ü¶Å','üêâ','ü¶Ö','ü¶ä','üê∫','ü¶à'];

const SL={
  'Hyperliquid':    {v:'hyperliquid-perps',    t:'hyperliquid'},
  'Aster':          {v:'aster-perps',          t:'aster-dex'},
  'edgeX':          {v:'edgex',                t:'edgex'},
  'Lighter':        {v:'lighter',              t:'lighter-v2'},
  'Paradex':        {v:'paradex',              t:'paradex'},
  'GRVT':           {v:'grvt',                 t:'grvt'},
  'Extended':       {v:'extended',             t:'extended'},
  'Ostium':         {v:'ostium',               t:'ostium'},
  'ApeX Omni':      {v:'apex-omni',            t:'apex-omni'},
  'Pacifica':       {v:'pacifica',             t:'pacifica'},
  'Variational':    {v:'variational',          t:'variational'},
  'Avantis':        {v:'avantis',              t:'avantis'},
  'Hibachi':        {v:'hibachi',              t:'hibachi'},
  'Reya':           {v:'reya',                 t:'reya-network'},
  'Ethereal':       {v:'ethereal-exchange',    t:'ethereal-dex'},
  'StandX':         {v:'standx',               t:'standx'},
  'Nado':           {v:'nado',                 t:'nado'},
  'Cascade':        {v:'cascade',              t:'cascade'},
  'TreadFi':        {v:'treadfi',              t:'treadfi'},
  'Risex Trade':    {v:'risex-trade',          t:'risex-trade'},
  '01 Exchange':    {v:'01-exchange',          t:'01-exchange'},
  'BasedApp':       {v:'basedapp',             t:'basedapp'},
  'Dreamcash':      {v:'dreamcash',            t:'dreamcash'},
  'Trade XYZ':      {v:'trade-xyz',            t:'trade-xyz'},
  'Hotstuff':       {v:'hotstuff',             t:'hotstuff'},
  'GTE':            {v:'gte',                  t:'gte'},
  'Dango':          {v:'dango',                t:'dango'},
  'Valhalla DeFi':  {v:'valhalla-defi',        t:'valhalla-defi'},
  'Backpack':       {v:'backpack',             t:'backpack'},
  'perpl':          {v:'perpl',                t:'perpl'},
  'Kuru':           {v:'kuru',                 t:'kuru'},
  'Bulk':           {v:'bulk',                 t:'bulk'},
  'Titan Exchange': {v:'titan-exchange',       t:'titan-protocol'},
  'Liquid':         {v:'liquid-perps',         t:'liquid-perps'},
  'HyENA':          {v:'hyena',                t:'hyena'},
};

const NM=Object.keys(SL);
let D=[],cS='volume',cD='desc',cF='';

function fm(n){if(n==null)return'‚Äî';if(n>=1e9)return'$'+(n/1e9).toFixed(2)+'B';if(n>=1e6)return'$'+(n/1e6).toFixed(2)+'M';if(n>=1e3)return'$'+(n/1e3).toFixed(1)+'K';return'$'+n.toFixed(0)}
function cH(v){if(v==null)return'<span class="ch na">‚Äî</span>';if(v>=0)return`<span class="ch up">‚ñ≤${v.toFixed(2)}%</span>`;return`<span class="ch dn">‚ñº${Math.abs(v).toFixed(2)}%</span>`}

const COLS=[
  {id:'rank',label:'#',w:'40px',al:'center'},
  {id:'name',label:'Perp DEX',sk:'name'},
  {id:'vol',label:'24H Perp Volume',sk:'volume'},
  {id:'vc',label:'Volume Œî',sk:'volChange'},
  {id:'tvl',label:'TVL',sk:'tvl'},
  {id:'tc',label:'TVL Œî',sk:'tvlChange'},
  {id:'sh',label:'Volume %',w:'85px'},
];
const TABS=[{l:'Volume',s:'volume'},{l:'TVL',s:'tvl'},{l:'Movers',s:'volChange'},{l:'A ‚Üí Z',s:'name'}];

function bH(){
  document.getElementById('th').innerHTML=COLS.map(c=>{
    if(!c.sk)return`<th style="${c.w?'width:'+c.w:''}${c.al?';text-align:'+c.al:''}">${c.label}</th>`;
    const a=cS===c.sk;
    return`<th style="${c.w?'width:'+c.w:''}"><span class="ths ${a?'act':''}" onclick="ts('${c.sk}')">${c.label}<span class="sa"><span class="a ${a&&cD==='asc'?'on':''}">‚ñ≤</span><span class="a ${a&&cD==='desc'?'on':''}">‚ñº</span></span></span></th>`;
  }).join('');
}
function bT(){document.getElementById('tg').innerHTML=TABS.map(t=>`<button class="tb ${cS===t.s?'on':''}" onclick="ss('${t.s}',this)">${t.l}</button>`).join('')}

function ts(k){if(cS===k)cD=cD==='desc'?'asc':'desc';else{cS=k;cD=k==='name'?'asc':'desc'}bH();bT();renderT()}
function ss(s,el){cS=s;cD=s==='name'?'asc':'desc';document.querySelectorAll('.tb').forEach(b=>b.classList.remove('on'));if(el)el.classList.add('on');bH();renderT()}

async function go(){
  const btn=document.getElementById('rb'),st=document.getElementById('stxt'),stag=document.getElementById('stag');
  btn.classList.add('spin');btn.disabled=true;st.textContent='Syncing‚Ä¶';stag.className='hs';

  try{
    const[vr,tr]=await Promise.all([
      fetch('https://api.llama.fi/overview/derivatives?excludeTotalDataChart=true&excludeTotalDataChartBreakdown=true'),
      fetch('https://api.llama.fi/protocols')
    ]);
    if(!vr.ok||!tr.ok)throw new Error('err');
    const vd=await vr.json(),td=await tr.json();

    const vm={};
    if(vd.protocols)vd.protocols.forEach(p=>{
      [p.defillamaId,p.slug,p.name,p.displayName,(p.name||'').replace(/\s+/g,'-'),(p.displayName||'').replace(/\s+/g,'-'),(p.module||'').replace('derivatives/','')]
      .forEach(k=>{if(k)vm[String(k).toLowerCase()]=p});
    });

    const tm={};
    td.forEach(p=>{[p.slug,p.name,(p.name||'').replace(/\s+/g,'-')].forEach(k=>{if(k)tm[k.toLowerCase()]=p})});

    D=NM.map((name,i)=>{
      const sl=SL[name];
      const fnd=(m,s)=>m[s]||m[name.toLowerCase()]||m[name.toLowerCase().replace(/\s+/g,'-')]||null;
      let vi=fnd(vm,sl.v),vol=null,vc=null;
      if(vi){vol=vi.total24h||vi.dailyVolume||null;vc=vi.change_1d??null;if(vc==null&&vi.total48hto24h&&vi.total24h){const p=vi.total48hto24h;if(p>0)vc=((vi.total24h-p)/p)*100}}
      let ti=fnd(tm,sl.t),tvl=null,tc=null,ch='‚Äî';
      if(ti){tvl=ti.tvl||null;tc=ti.change_1d??null;ch=ti.chain||ti.chains?.join(', ')||'‚Äî'}
      if(ch==='‚Äî'&&vi)ch=vi.chains?.join(', ')||vi.chain||'‚Äî';
      return{name,chain:ch,emoji:EE[i%EE.length],color:CC[i%CC.length],volume:vol?Math.round(vol):null,tvl:tvl?Math.round(tvl):null,volumeChange:vc!=null?+vc.toFixed(2):null,tvlChange:tc!=null?+tc.toFixed(2):null,has:vol!=null||tvl!=null};
    });

    const found=D.filter(d=>d.has).length;
    st.textContent=`Synced ${found} protocols`;stag.className='hs ok';
    stamp();renderAll();
  }catch(e){
    console.error(e);st.textContent='Offline ‚Äî sample data';stag.className='hs err';
    fb();renderAll();
  }
  btn.classList.remove('spin');btn.disabled=false;
}

function fb(){
  const d=new Date(),seed=d.getFullYear()*1e4+(d.getMonth()+1)*100+d.getDate();
  const sr=s=>{let x=Math.sin(s)*1e4;return x-Math.floor(x)};
  const b=[8500e6,2200e6,1200e6,950e6,800e6,700e6,550e6,420e6,350e6,280e6,220e6,180e6,150e6,120e6,100e6,85e6,70e6,55e6,42e6,35e6,28e6,22e6,18e6,15e6,12e6,9e6,7e6,5e6,4e6,3e6,2e6,1.5e6,1e6,.7e6,.4e6];
  D=NM.map((n,i)=>{const s=seed+i*137,base=b[i]||1e6;return{name:n,chain:'‚Äî',emoji:EE[i%EE.length],color:CC[i%CC.length],volume:Math.round(base*(.8+sr(s)*.4)),tvl:Math.round(base*(.05+sr(s+1e3)*.15)),volumeChange:+((sr(s+2e3)-.45)*50).toFixed(2),tvlChange:+((sr(s+3e3)-.45)*25).toFixed(2),has:true}});
  stamp();
}

function stamp(){
  const n=new Date(),p=x=>(''+x).padStart(2,'0');
  document.getElementById('lu').textContent=`${n.getFullYear()}-${p(n.getMonth()+1)}-${p(n.getDate())} ${p(n.getHours())}:${p(n.getMinutes())} UTC`;
  document.getElementById('dc').textContent=NM.length;
}

function renderMetrics(){
  const wv=D.filter(d=>d.volume),wt=D.filter(d=>d.tvl);
  const tv=wv.reduce((s,d)=>s+d.volume,0),tt=wt.reduce((s,d)=>s+d.tvl,0);
  const topV=[...wv].sort((a,b)=>b.volume-a.volume)[0];
  const topT=[...wt].sort((a,b)=>b.tvl-a.tvl)[0];
  document.getElementById('sg').innerHTML=`
    <div class="sg-card"><div class="sg-label">üí∞ 24h Perp Volume</div><div class="sg-val cyan">${fm(tv)}</div><div class="sg-sub">Across ${wv.length} venues with volume</div><div class="sg-accent" style="background:var(--grad1)"></div></div>
    <div class="sg-card"><div class="sg-label">üè¶ Total TVL</div><div class="sg-val purple">${fm(tt)}</div><div class="sg-sub">${wt.length} venues with TVL</div><div class="sg-accent" style="background:var(--grad2)"></div></div>
    <div class="sg-card"><div class="sg-label">üëë Top by Vol</div><div class="sg-val white">${topV?topV.name:'‚Äî'}</div><div class="sg-sub">${topV?fm(topV.volume)+' daily perp volume':''}</div></div>
    <div class="sg-card"><div class="sg-label">üèÜ Top by TVL</div><div class="sg-val white">${topT?topT.name:'‚Äî'}</div><div class="sg-sub">${topT?fm(topT.tvl)+' total locked':''}</div></div>`;
}

function renderDom(){
  const mk=(data,key,bId,lId,topId)=>{
    const items=data.filter(d=>d[key]).sort((a,b)=>b[key]-a[key]);
    const tot=items.reduce((s,d)=>s+d[key],0);
    if(!tot)return;
    const top=items.slice(0,10),rest=items.slice(10).reduce((s,d)=>s+d[key],0);
    const topItem=items[0];
    if(topId&&topItem)document.getElementById(topId).innerHTML=`Top venue: <strong>${topItem.name}</strong>`;
    document.getElementById(bId).innerHTML=top.map(d=>{
      const p=d[key]/tot*100;
      return`<div class="dom-seg" style="width:${Math.max(p,.4)}%;background:${d.color}" data-tip="${d.name}: ${p.toFixed(1)}%" onmouseenter="sT(event,this)" onmouseleave="hT()"></div>`;
    }).join('')+(rest>0?`<div class="dom-seg" style="width:${rest/tot*100}%;background:#2a2f45" data-tip="Others: ${(rest/tot*100).toFixed(1)}%" onmouseenter="sT(event,this)" onmouseleave="hT()"></div>`:'');
    document.getElementById(lId).innerHTML=top.slice(0,8).map(d=>`<div class="dl-i"><div class="dl-dot" style="background:${d.color}"></div>${d.emoji} ${d.name} <strong>${(d[key]/tot*100).toFixed(1)}%</strong></div>`).join('');
  };
  mk(D,'volume','dvb','dvl','topVolLabel');
  mk(D,'tvl','dtb','dtl','topTvlLabel');
}

function gS(){
  let d=[...D];
  if(cF){const f=cF.toLowerCase();d=d.filter(x=>x.name.toLowerCase().includes(f)||x.chain.toLowerCase().includes(f))}
  const dir=cD==='asc'?1:-1;
  switch(cS){
    case'volume':d.sort((a,b)=>((b.volume||0)-(a.volume||0))*dir);break;
    case'tvl':d.sort((a,b)=>((b.tvl||0)-(a.tvl||0))*dir);break;
    case'name':d.sort((a,b)=>a.name.localeCompare(b.name)*dir);break;
    case'volChange':d.sort((a,b)=>((b.volumeChange||-9999)-(a.volumeChange||-9999))*dir);break;
    case'tvlChange':d.sort((a,b)=>((b.tvlChange||-9999)-(a.tvlChange||-9999))*dir);break;
  }return d;
}

function renderT(){
  const sorted=gS();
  const maxV=Math.max(...D.filter(d=>d.volume).map(d=>d.volume),1);
  const totalV=D.filter(d=>d.volume).reduce((s,d)=>s+d.volume,0)||1;
  const tb=document.getElementById('tb');
  if(!sorted.length){tb.innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3);font-size:12px">No results found</td></tr>';return}
  tb.innerHTML=sorted.map((d,i)=>{
    const rc=i===0?'g':i===1?'s':i===2?'b':'';
    const pct=d.volume?Math.round(d.volume/maxV*100):0;
    const volPct=d.volume?((d.volume/totalV)*100).toFixed(1):'‚Äî';
    return`<tr>
      <td style="text-align:center"><div class="rk ${rc}">${i+1}</div></td>
      <td><div class="dc"><div class="dav" style="background:${d.color}10;border:1px solid ${d.color}22">${d.emoji}</div><div class="dnf"><h4>${d.name}</h4><span>${d.chain}</span></div></div></td>
      <td>${d.volume!=null?`<span class="v vc">${fm(d.volume)}</span>`:'<span class="v na">No data</span>'}</td>
      <td>${cH(d.volumeChange)}</td>
      <td>${d.tvl!=null?`<span class="v tc">${fm(d.tvl)}</span>`:'<span class="v na">No data</span>'}</td>
      <td>${cH(d.tvlChange)}</td>
      <td><div style="display:flex;align-items:center;gap:6px"><div class="sb"><div class="sf" style="width:${pct}%;background:${d.color}"></div></div><span style="font-size:9px;color:var(--text3);font-family:'JetBrains Mono',monospace;font-weight:600">${volPct}%</span></div></td>
    </tr>`;
  }).join('');
}

function renderAll(){renderMetrics();renderDom();bH();bT();renderT()}

function sT(e,el){const t=document.getElementById('tip');t.textContent=el.dataset.tip;t.style.display='block';const r=el.getBoundingClientRect();t.style.left=Math.min(r.left+r.width/2-t.offsetWidth/2,window.innerWidth-t.offsetWidth-8)+'px';t.style.top=r.top-28+'px'}
function hT(){document.getElementById('tip').style.display='none'}

function tick(){
  const n=new Date(),t=new Date(n);
  t.setUTCDate(t.getUTCDate()+1);t.setUTCHours(0,0,0,0);
  const d=t-n,h=Math.floor(d/36e5),m=Math.floor(d%36e5/6e4),s=Math.floor(d%6e4/1e3);
  document.getElementById('cd').textContent=`${(''+h).padStart(2,'0')}:${(''+m).padStart(2,'0')}:${(''+s).padStart(2,'0')}`;
}

bH();bT();setInterval(tick,1e3);tick();go();
</script>
</body>
</html>